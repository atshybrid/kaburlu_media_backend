generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_DIRECT")
}

/// WhatsApp message templates synced from Meta Business API
model WhatsappTemplate {
  id              String   @id @default(cuid())
  templateId      String   @unique /// Meta template ID (e.g., "123456789")
  name            String   @unique /// Template name (e.g., "send_idcard_reporter")
  language        String   /// Language code (e.g., "en_US", "te")
  category        String?  /// AUTHENTICATION, MARKETING, UTILITY
  status          String   /// APPROVED, PENDING, REJECTED, DISABLED
  headerType      String?  /// NONE, TEXT, IMAGE, VIDEO, DOCUMENT
  headerText      String?  /// Header text if type is TEXT
  bodyText        String?  /// Body template text with {{1}}, {{2}} placeholders
  footerText      String?  /// Footer text
  buttonsJson     Json?    /// Array of button configs
  componentsJson  Json?    /// Full components array from Meta API
  qualityScore    String?  /// GREEN, YELLOW, RED, UNKNOWN
  rejectedReason  String?  /// Reason if rejected
  lastSyncedAt    DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status])
  @@index([category])
}

model OtpLog {
  id           String   @id @default(cuid())
  mobileNumber String
  otp          String
  expiresAt    DateTime
  createdAt    DateTime @default(now())
}

model ShortNews {
  categoryId             String
  aiRemark               String?
  id                     String            @id @default(cuid())
  title                  String
  content                String
  mediaUrls              String[]
  latitude               Float?
  longitude              Float?
  address                String?
  authorId               String
  status                 String            @default("PENDING")
  aiPlagiarism           Json?
  aiSensitive            Json?
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  allowComments          Boolean           @default(true)
  featuredImage          String?
  language               String?
  publishDate            DateTime?
  seo                    Json?
  slug                   String?
  summary                String?
  tags                   String[]
  accuracyMeters         Float?
  placeId                String?
  placeName              String?
  provider               String?
  source                 String?
  timestampUtc           DateTime?
  headings               Json?
  templateId             String?
  isBreaking             Boolean           @default(false)
  aiApprovalStatus       String?
  aiViolationCount       Int               @default(0)
  aiValidationIssues     Json?
  pushNotificationSent   Boolean           @default(false)
  pushNotificationSentAt DateTime?
  comments               Comment[]
  author                 User              @relation(fields: [authorId], references: [id])
  options                ShortNewsOption[]
  reads                  ShortNewsRead[]
}

enum ShortNewsOptionType {
  POSITIVE
  NEGATIVE
}

model User {
  mobileNumber           String?                @unique
  roleId                 String
  languageId             String
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  mpin                   String?
  email                  String?                @unique
  id                     String                 @id @default(cuid())
  status                 String                 @default("PENDING")
  upgradedAt             DateTime?
  firebaseUid            String?
  lastLoginAt            DateTime?
  loginCount             Int                    @default(0)
  articles               Article[]
  proofEvidenceUploaded  ArticleProofEvidence[] @relation("ProofEvidence_UploadedBy")
  proofRequestsAssigned  ArticleProofRequest[]  @relation("ProofRequest_AssignedTo")
  proofRequestsCreated   ArticleProofRequest[]  @relation("ProofRequest_RequestedBy")
  proofRequestsReviewed  ArticleProofRequest[]  @relation("ProofRequest_ReviewedBy")
  articleReads           ArticleRead[]
  articleViews           ArticleView[]
  comments               Comment[]
  contentReactions       ContentReaction[]
  contentReads           ContentRead[]
  devices                Device[]
  dislikes               Dislike[]
  familyMemberships      FamilyMember[]
  relatedFamilyRelations FamilyRelation[]       @relation("FamilyRelation_relatedUser")
  familyRelations        FamilyRelation[]       @relation("FamilyRelation_user")
  createdFamilyTrees     FamilyTree[]
  familyTreeMemberships  FamilyTreeMember[]
  likes                  Like[]
  media                  Media[]
  newspaperArticles      NewspaperArticle[]
  reporterProfile        Reporter?
  shortNews              ShortNews[]
  shortNewsOptions       ShortNewsOption[]
  shortNewsReads         ShortNewsRead[]
  createdSurnames        Surname[]
  tenantWebArticles      TenantWebArticle[]     @relation("User_WebArticles")
  language               Language               @relation(fields: [languageId], references: [id])
  role                   Role                   @relation(fields: [roleId], references: [id])
  userEncryptionKey      UserEncryptionKey?
  location               UserLocation?
  profile                UserProfile?
  loginSessions          UserLoginSession[]
}

/// Tracks user login sessions for working hours calculation
model UserLoginSession {
  id             String    @id @default(cuid())
  userId         String
  loginAt        DateTime  @default(now())
  logoutAt       DateTime?
  lastActivityAt DateTime  @default(now())
  durationMinutes Int?
  deviceInfo     String?
  ipAddress      String?
  createdAt      DateTime  @default(now())
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([loginAt])
  @@index([userId, loginAt])
}

/// Stores editable AI prompts by key. Allows changing prompts without code changes.
model Prompt {
  id          String   @id @default(cuid())
  key         String   @unique
  content     String
  description String?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
}

model Role {
  createdAt   DateTime @default(now())
  id          String   @id @default(cuid())
  updatedAt   DateTime @updatedAt
  permissions Json
  name        String   @unique
  users       User[]
}

model Country {
  id             String         @id @default(cuid())
  name           String         @unique
  code           String?        @unique
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  states         State[]
  tenantEntities TenantEntity[] @relation("TenantEntity_publicationCountry")
}

model Language {
  name              String             @unique
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  code              String             @unique
  id                String             @id @default(cuid())
  direction         String?            @default("ltr")
  isDeleted         Boolean            @default(false)
  nativeName        String?
  articles          Article[]          @relation("Article_language")
  domainLangs       DomainLanguage[]
  newspaperArticles NewspaperArticle[]
  tenantEntities    TenantEntity[]     @relation("TenantEntity_language")
  webArticles       TenantWebArticle[] @relation("Language_WebArticles")
  users             User[]
}

model State {
  name                      String                     @unique
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  id                        String                     @id @default(cuid())
  isDeleted                 Boolean                    @default(false)
  countryId                 String
  contentReads              ContentRead[]              @relation("ContentRead_state")
  districts                 District[]
  epaperPublicationEditions EpaperPublicationEdition[] @relation("State_EpaperPublicationEditions")
  reporters                 Reporter[]
  country                   Country                    @relation(fields: [countryId], references: [id])
  translations              StateTranslation[]
  surnames                  Surname[]
  tenants                   Tenant[]
  tenantEntities            TenantEntity[]             @relation("TenantEntity_publicationState")
  userProfiles              UserProfile[]              @relation("UserProfile_state")
}

model StateTranslation {
  id        String   @id @default(cuid())
  stateId   String
  language  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  state     State    @relation(fields: [stateId], references: [id], onDelete: Cascade)

  @@unique([stateId, language])
}

model District {
  id                           String                        @id @default(cuid())
  name                         String
  stateId                      String
  isDeleted                    Boolean                       @default(false)
  createdAt                    DateTime                      @default(now())
  updatedAt                    DateTime                      @updatedAt
  assemblyConstituencies       AssemblyConstituency[]        @relation("DistrictAssemblyConstituencies")
  contentReads                 ContentRead[]                 @relation("ContentRead_district")
  state                        State                         @relation(fields: [stateId], references: [id])
  translations                 DistrictTranslation[]
  epaperPublicationSubEditions EpaperPublicationSubEdition[] @relation("District_EpaperPublicationSubEditions")
  mandals                      Mandal[]
  reporters                    Reporter[]
  tenantEntitiesPrinting       TenantEntity[]                @relation("TenantEntity_printingDistrict")
  tenantEntitiesPublication    TenantEntity[]                @relation("TenantEntity_publicationDistrict")
  userProfiles                 UserProfile[]                 @relation("UserProfile_district")
}

model DistrictTranslation {
  id         String   @id @default(cuid())
  districtId String
  language   String
  name       String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  district   District @relation(fields: [districtId], references: [id], onDelete: Cascade)

  @@unique([districtId, language])
}

model Mandal {
  id                        String              @id @default(cuid())
  name                      String
  districtId                String
  isDeleted                 Boolean             @default(false)
  createdAt                 DateTime            @default(now())
  updatedAt                 DateTime            @updatedAt
  isAssemblyConstituency    Boolean             @default(false)
  contentReads              ContentRead[]       @relation("ContentRead_mandal")
  district                  District            @relation(fields: [districtId], references: [id])
  translations              MandalTranslation[]
  reporters                 Reporter[]
  tenantEntitiesPrinting    TenantEntity[]      @relation("TenantEntity_printingMandal")
  tenantEntitiesPublication TenantEntity[]      @relation("TenantEntity_publicationMandal")
  userProfiles              UserProfile[]       @relation("UserProfile_mandal")
  villages                  Village[]
}

model MandalTranslation {
  id        String   @id @default(cuid())
  mandalId  String
  language  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  mandal    Mandal   @relation(fields: [mandalId], references: [id], onDelete: Cascade)

  @@unique([mandalId, language])
}

model Category {
  createdAt                       DateTime                @default(now())
  updatedAt                       DateTime                @updatedAt
  id                              String                  @id @default(cuid())
  name                            String
  slug                            String                  @unique
  parentId                        String?
  isDeleted                       Boolean                 @default(false)
  iconUrl                         String?
  parent                          Category?               @relation("SubCategories", fields: [parentId], references: [id])
  children                        Category[]              @relation("SubCategories")
  translations                    CategoryTranslation[]
  domainCategories                DomainCategory[]
  homepageSectionConfigs          HomepageSectionConfig[] @relation("HomepageSectionConfig_category")
  homepageSectionSecondaryConfigs HomepageSectionConfig[] @relation("HomepageSectionConfig_secondaryCategory")
  homepageSectionTertiaryConfigs  HomepageSectionConfig[] @relation("HomepageSectionConfig_tertiaryCategory")
  newspaperArticles               NewspaperArticle[]
  webArticles                     TenantWebArticle[]
  articles                        Article[]               @relation("ArticleToCategory")
}

model CategoryTranslation {
  id         String   @id @default(cuid())
  categoryId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  name       String
  language   String
  category   Category @relation(fields: [categoryId], references: [id])

  @@unique([categoryId, language])
}

model Article {
  id                String             @id @default(cuid())
  title             String
  content           String
  authorId          String
  scheduledAt       DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  images            String[]
  isBreakingNews    Boolean            @default(false)
  isTrending        Boolean            @default(false)
  tags              String[]
  viewCount         Int                @default(0)
  status            String             @default("DRAFT")
  headlines         String?
  longNews          String?
  shortNews         String?
  type              String
  contentJson       Json?
  languageId        String?
  tenantId          String?
  priority          Int                @default(3) // 1=high priority, 2=medium, 3=low
  aiUsageEvents     AiUsageEvent[]
  author            User               @relation(fields: [authorId], references: [id])
  language          Language?          @relation("Article_language", fields: [languageId], references: [id])
  tenant            Tenant?            @relation(fields: [tenantId], references: [id])
  articleReads      ArticleRead[]
  articleViews      ArticleView[]
  comments          Comment[]
  dislikes          Dislike[]
  likes             Like[]
  newspaperArticles NewspaperArticle[] @relation("ArticleToNewspaper")
  categories        Category[]         @relation("ArticleToCategory")
  Article_A         Article[]          @relation("RelatedArticles")
  Article_B         Article[]          @relation("RelatedArticles")

  @@index([tenantId, createdAt])
  @@index([priority])
}

/// Website-focused, tenant-scoped article with SEO-friendly JSON payload
model TenantWebArticle {
  id                 String    @id @default(cuid())
  tenantId           String
  domainId           String?
  languageId         String?
  authorId           String?
  title              String
  slug               String
  status             String    @default("DRAFT")
  coverImageUrl      String?
  contentJson        Json
  seoTitle           String?
  metaDescription    String?
  jsonLd             Json?
  tags               String[]
  publishedAt        DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  categoryId         String?
  viewCount          Int       @default(0)
  isBreaking         Boolean   @default(false)
  aiApprovalStatus   String?
  aiViolationCount   Int       @default(0)
  aiValidationIssues Json?
  isLive             Boolean   @default(false)
  shareCount         Int       @default(0)
  previousArticleId  String?
  nextArticleId      String?
  author             User?     @relation("User_WebArticles", fields: [authorId], references: [id])
  category           Category? @relation(fields: [categoryId], references: [id])
  domain             Domain?   @relation("Domain_WebArticles", fields: [domainId], references: [id])
  language           Language? @relation("Language_WebArticles", fields: [languageId], references: [id])
  tenant             Tenant    @relation("Tenant_WebArticles", fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, domainId, languageId, slug])
  @@index([tenantId, createdAt])
  @@index([categoryId])
  @@index([tenantId, viewCount])
  @@index([tenantId, shareCount], map: "TenantWebArticle_shareCount_idx")
}

model RawArticle {
  id            String   @id @default(cuid())
  tenantId      String
  domainId      String
  reporterId    String
  languageId    String
  title         String   @default("")
  content       String
  categoryIds   Json
  coverImageUrl String?
  media         Json?
  aiProvider    String   @default("openai")
  status        String   @default("NEW")
  errorCode     String?
  usage         Json?
  webArticleId  String?
  shortNewsId   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Tenant {
  id                           String                        @id @default(cuid())
  name                         String
  slug                         String                        @unique
  stateId                      String?
  prgiNumber                   String                        @unique
  prgiStatus                   PrgiStatus                    @default(PENDING)
  prgiSubmittedAt              DateTime?
  prgiVerifiedAt               DateTime?
  prgiRejectedAt               DateTime?
  prgiRejectionReason          String?
  prgiDocuments                Json?
  createdAt                    DateTime                      @default(now())
  updatedAt                    DateTime                      @updatedAt
  aiUsageEvents                AiUsageEvent[]
  articles                     Article[]
  proofRequests                ArticleProofRequest[]         @relation("Tenant_ProofRequests")
  billingCreditBalances        BillingCreditBalance[]
  billingInvoices              BillingInvoice[]
  billingUsageEvents           BillingUsageEvent[]
  domains                      Domain[]
  domainSettings               DomainSettings[]              @relation("Tenant_DomainSettings")
  epaperBlockTemplates         EpaperBlockTemplate[]         @relation("Tenant_EpaperBlockTemplates")
  epaperEditions               EpaperEdition[]               @relation("Tenant_EpaperEditions")
  epaperPdfIssues              EpaperPdfIssue[]
  epaperPublicationEditions    EpaperPublicationEdition[]    @relation("Tenant_EpaperPublicationEditions")
  epaperPublicationSubEditions EpaperPublicationSubEdition[] @relation("Tenant_EpaperPublicationSubEditions")
  epaperSettings               EpaperSettings?               @relation("Tenant_EpaperSettings")
  homepageSectionConfigs       HomepageSectionConfig[]
  newsletterSubscriptions      NewsletterSubscription[]
  newspaperArticles            NewspaperArticle[]
  razorpayConfig               RazorpayConfig?
  reporters                    Reporter[]
  reporterDesignations         ReporterDesignation[]
  reporterOnboardingOrders     ReporterOnboardingOrder[]
  reporterPayments             ReporterPayment[]
  state                        State?                        @relation(fields: [stateId], references: [id])
  entity                       TenantEntity?                 @relation("Tenant_TenantEntity")
  featureFlags                 TenantFeatureFlags?
  homepageSections             TenantHomepageSection[]
  idCardSettings               TenantIdCardSettings?
  navigation                   TenantNavigation?
  settings                     TenantSettings?               @relation("Tenant_TenantSettings")
  staticPages                  TenantStaticPage[]
  subscriptions                TenantSubscription[]
  theme                        TenantTheme?
  translations                 TenantTranslation[]
  webArticles                  TenantWebArticle[]            @relation("Tenant_WebArticles")
  villages                     Village[]
  articleQuota                 TenantArticleQuota?
  
  // Wallet & Subscription System
  wallet                       TenantWallet?
  pricing                      TenantPricing[]
  usageMonthly                 TenantUsageMonthly[]
  subscriptionLocked           Boolean                       @default(false)
  lockedReason                 String?
  lockedAt                     DateTime?
}

/// Tenant ePaper publication edition definition (State-level or umbrella edition).
/// This is NOT the daily generated EpaperEdition used by the block-layout generator.
model EpaperPublicationEdition {
  id             String                        @id @default(cuid())
  tenantId       String
  name           String
  slug           String
  stateId        String?
  coverImageUrl  String?
  seoTitle       String?
  seoDescription String?
  seoKeywords    String?
  isActive       Boolean                       @default(true)
  isDeleted      Boolean                       @default(false)
  createdAt      DateTime                      @default(now())
  updatedAt      DateTime                      @updatedAt
  pdfIssues      EpaperPdfIssue[]
  state          State?                        @relation("State_EpaperPublicationEditions", fields: [stateId], references: [id])
  tenant         Tenant                        @relation("Tenant_EpaperPublicationEditions", fields: [tenantId], references: [id], onDelete: Cascade)
  subEditions    EpaperPublicationSubEdition[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([stateId])
  @@index([isActive, isDeleted])
}

/// Tenant ePaper publication sub-edition definition (District-level).
model EpaperPublicationSubEdition {
  id             String                   @id @default(cuid())
  tenantId       String
  editionId      String
  name           String
  slug           String
  districtId     String?
  coverImageUrl  String?
  seoTitle       String?
  seoDescription String?
  seoKeywords    String?
  isActive       Boolean                  @default(true)
  isDeleted      Boolean                  @default(false)
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  pdfIssues      EpaperPdfIssue[]
  district       District?                @relation("District_EpaperPublicationSubEditions", fields: [districtId], references: [id])
  edition        EpaperPublicationEdition @relation(fields: [editionId], references: [id], onDelete: Cascade)
  tenant         Tenant                   @relation("Tenant_EpaperPublicationSubEditions", fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([editionId, slug])
  @@index([tenantId])
  @@index([editionId])
  @@index([districtId])
  @@index([isActive, isDeleted])
}

/// PDF-based daily issue for a tenant's publication edition/sub-edition.
/// Exactly one of (editionId, subEditionId) must be set.
/// Uploading the same (tenantId + issueDate + target) should replace existing.
model EpaperPdfIssue {
  id                String                       @id @default(cuid())
  tenantId          String
  issueDate         DateTime                     @db.Date
  editionId         String?
  subEditionId      String?
  pdfUrl            String
  coverImageUrl     String?
  pageCount         Int                          @default(0)
  uploadedByUserId  String?
  createdAt         DateTime                     @default(now())
  updatedAt         DateTime                     @updatedAt
  /// WebP version of cover image for optimized delivery (frontend prefers this)
  coverImageUrlWebp String?
  /// JPEG version of cover image for social sharing/OG tags (most platforms prefer JPEG)
  coverImageUrlJpeg String?
  /// Whether this issue uses the new PDF-only mode (no pre-generated page images)
  pdfOnlyMode       Boolean                      @default(false)
  clips             EpaperArticleClip[]
  edition           EpaperPublicationEdition?    @relation(fields: [editionId], references: [id], onDelete: Cascade)
  subEdition        EpaperPublicationSubEdition? @relation(fields: [subEditionId], references: [id], onDelete: Cascade)
  tenant            Tenant                       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pages             EpaperPdfPage[]
  cropSessions      PublicCropSession[]

  @@unique([tenantId, issueDate, editionId])
  @@unique([tenantId, issueDate, subEditionId])
  @@index([tenantId, issueDate])
  @@index([editionId])
  @@index([subEditionId])
}

model EpaperPdfPage {
  id           String         @id @default(cuid())
  issueId      String
  pageNumber   Int
  /// PNG master image URL (lossless, archive quality)
  imageUrl     String
  createdAt    DateTime       @default(now())
  /// WebP optimized image URL for frontend delivery (~80% smaller)
  imageUrlWebp String?
  /// JPEG version for social sharing/OG tags (platform compatibility)
  imageUrlJpeg String?
  issue        EpaperPdfIssue @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@unique([issueId, pageNumber])
  @@index([issueId])
}

/// Article clip coordinates within a PDF page (PDF coordinate system).
/// This is the HEART of the new clip-based ePaper system.
/// Coordinates are stored in PDF points (1/72 inch), NOT pixels.
model EpaperArticleClip {
  id           String              @id @default(cuid())
  issueId      String
  pageNumber   Int
  /// PDF coordinates (in points, origin at bottom-left of page)
  x            Float
  y            Float
  width        Float
  height       Float
  /// Optional column hint for layout: 'left', 'right', 'full', or null
  column       String?
  /// Detection source: 'auto' (AI/algorithm) or 'manual' (editor)
  source       String              @default("manual")
  /// Confidence score for auto-detected clips (0.0 - 1.0)
  confidence   Float?
  /// Whether this clip is active/visible
  isActive     Boolean             @default(true)
  /// Who created/updated: 'system', 'editor', 'public'
  createdBy    String              @default("editor")
  updatedBy    String              @default("editor")
  /// Optional title/label for the clip
  title        String?
  /// Optional article link or reference
  articleRef   String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  /// Soft delete timestamp (null = active)
  deletedAt    DateTime?
  issue        EpaperPdfIssue      @relation(fields: [issueId], references: [id], onDelete: Cascade)
  assets       EpaperClipAsset[]
  history      EpaperClipHistory[]
  cropSessions PublicCropSession[]

  @@index([issueId])
  @@index([issueId, pageNumber])
  @@index([isActive])
  @@index([deletedAt])
}

/// Cached clip image assets (generated on-demand, not at upload time).
/// These are derived from PDF + clip coordinates when needed for sharing.
model EpaperClipAsset {
  id          String            @id @default(cuid())
  clipId      String
  /// Asset type: 'webp', 'jpeg', 'png'
  type        String
  /// Public URL of the cached image
  url         String
  /// File size in bytes (for analytics)
  sizeBytes   Int?
  generatedAt DateTime          @default(now())
  clip        EpaperArticleClip @relation(fields: [clipId], references: [id], onDelete: Cascade)

  @@unique([clipId, type])
  @@index([clipId])
}

/// Temporary session for public users to update clip coordinates.
/// Provides secure, time-limited access without full auth.
/// TTL = 5 minutes by default.
model PublicCropSession {
  id          String             @id @default(cuid())
  sessionKey  String             @unique @default(cuid())
  issueId     String
  clipId      String?
  /// Session expiry time (default: createdAt + 5 minutes)
  expiresAt   DateTime
  /// Whether session has been used (one-time use)
  used        Boolean            @default(false)
  /// Security: hashed IP for audit
  ipHash      String?
  /// Security: user agent for audit
  userAgent   String?
  createdAt   DateTime           @default(now())
  /// Number of updates made via this session (rate limiting: max 3)
  updateCount Int                @default(0)
  clip        EpaperArticleClip? @relation(fields: [clipId], references: [id], onDelete: Cascade)
  issue       EpaperPdfIssue     @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@index([sessionKey])
  @@index([issueId])
  @@index([expiresAt])
}

/// Audit history for clip coordinate changes (especially public updates).
/// Used to track who changed what and when.
model EpaperClipHistory {
  id             String            @id @default(cuid())
  clipId         String
  /// Previous coordinates before the change
  previousX      Float
  previousY      Float
  previousWidth  Float
  previousHeight Float
  /// New coordinates after the change
  newX           Float
  newY           Float
  newWidth       Float
  newHeight      Float
  /// Who made the change: 'editor', 'public', 'system'
  changedBy      String
  /// Optional crop session ID for public updates
  cropSessionId  String?
  /// IP hash for public updates (audit)
  ipHash         String?
  createdAt      DateTime          @default(now())
  clip           EpaperArticleClip @relation(fields: [clipId], references: [id], onDelete: Cascade)

  @@index([clipId])
  @@index([changedBy])
  @@index([createdAt])
}

/// Tenant-scoped static website pages (e.g. /about-us, /privacy-policy)
model TenantStaticPage {
  id          String   @id @default(cuid())
  tenantId    String
  slug        String
  title       String?
  contentHtml String
  meta        Json?
  published   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, slug])
  @@index([slug])
}

model TenantTranslation {
  id        String   @id @default(cuid())
  tenantId  String
  language  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, language])
  @@index([language])
}

model Domain {
  id                     String                  @id @default(cuid())
  domain                 String                  @unique
  tenantId               String
  isPrimary              Boolean                 @default(false)
  status                 DomainStatus            @default(PENDING)
  verificationToken      String?
  verificationMethod     String?
  verifiedAt             DateTime?
  lastCheckAt            DateTime?
  lastCheckStatus        String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  kind                   DomainKind              @default(NEWS)
  sampleDataStatus       String?
  sampleDataMessage      String?
  sampleDataGeneratedAt  DateTime?
  tenant                 Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  categories             DomainCategory[]
  checkLogs              DomainCheckLog[]
  languages              DomainLanguage[]
  settings               DomainSettings?         @relation("Domain_DomainSettings")
  homepageSectionConfigs HomepageSectionConfig[]
  webArticles            TenantWebArticle[]      @relation("Domain_WebArticles")

  @@index([sampleDataStatus])
}

model BillingPlan {
  id              String                 @id @default(cuid())
  name            String
  currency        BillingCurrency        @default(INR)
  cycle           BillingCycle           @default(MONTHLY)
  baseAmountMinor Int                    @default(0)
  isActive        Boolean                @default(true)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  components      BillingPlanComponent[]
  subscriptions   TenantSubscription[]

  @@index([isActive, createdAt])
}

model BillingPlanComponent {
  id              String           @id @default(cuid())
  planId          String
  component       BillingComponent
  includedUnits   Int              @default(0)
  unitAmountMinor Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  plan            BillingPlan      @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, component])
  @@index([component])
}

model TenantSubscription {
  id                 String              @id @default(cuid())
  tenantId           String
  planId             String
  status             SubscriptionStatus  @default(ACTIVE)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean             @default(false)
  canceledAt         DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  invoices           BillingInvoice[]
  usageEvents        BillingUsageEvent[]
  plan               BillingPlan         @relation(fields: [planId], references: [id])
  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([planId])
}

/// Usage events for metered / one-time charges.
/// Example: newspaper design pages => component=NEWSPAPER_DESIGN_PAGE, quantity=number of pages.
model BillingUsageEvent {
  id             String              @id @default(cuid())
  tenantId       String
  subscriptionId String?
  component      BillingComponent
  quantity       Int                 @default(1)
  occurredAt     DateTime            @default(now())
  meta           Json?
  createdAt      DateTime            @default(now())
  subscription   TenantSubscription? @relation(fields: [subscriptionId], references: [id])
  tenant         Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, occurredAt])
  @@index([subscriptionId, occurredAt])
  @@index([component, occurredAt])
}

/// Prepaid credit balance per tenant and component.
/// Used to enforce prepaid usage (e.g., design pages beyond includedUnits).
model BillingCreditBalance {
  id        String           @id @default(cuid())
  tenantId  String
  component BillingComponent
  balance   Int              @default(0)
  updatedAt DateTime         @updatedAt
  createdAt DateTime         @default(now())
  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, component])
  @@index([tenantId])
  @@index([component])
}

model BillingInvoice {
  id                String                   @id @default(cuid())
  tenantId          String
  subscriptionId    String?
  kind              BillingInvoiceKind       @default(SUBSCRIPTION)
  status            InvoiceStatus            @default(DRAFT)
  currency          BillingCurrency          @default(INR)
  periodStart       DateTime
  periodEnd         DateTime
  totalAmountMinor  Int                      @default(0)
  razorpayOrderId   String?                  @unique
  razorpayPaymentId String?
  paidAt            DateTime?
  meta              Json?
  externalRef       String?
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  subscription      TenantSubscription?      @relation(fields: [subscriptionId], references: [id])
  tenant            Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lineItems         BillingInvoiceLineItem[]
  usageMonthly      TenantUsageMonthly?

  @@index([tenantId, periodStart, periodEnd])
  @@index([status, createdAt])
}

model BillingInvoiceLineItem {
  id              String            @id @default(cuid())
  invoiceId       String
  component       BillingComponent?
  description     String
  quantity        Int               @default(1)
  unitAmountMinor Int               @default(0)
  amountMinor     Int               @default(0)
  createdAt       DateTime          @default(now())
  invoice         BillingInvoice    @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

/// Tenant wallet for prepaid balance management
model TenantWallet {
  id                 String              @id @default(cuid())
  tenantId           String              @unique
  balanceMinor       Int                 @default(0) // Current available balance in paise
  lockedBalanceMinor Int                 @default(0) // Balance reserved for pending invoices
  currency           BillingCurrency     @default(INR)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transactions       WalletTransaction[]

  @@index([tenantId])
}

/// Wallet transaction history
model WalletTransaction {
  id                String                @id @default(cuid())
  walletId          String
  type              WalletTransactionType
  amountMinor       Int // Positive for credit, negative for debit
  balanceAfterMinor Int // Snapshot of balance after this transaction
  description       String
  referenceType     String? // INVOICE, TOPUP, REFUND, ADJUSTMENT
  referenceId       String? // Related invoice/payment ID
  meta              Json?
  createdAt         DateTime              @default(now())
  createdBy         String? // User ID who performed the action
  wallet            TenantWallet          @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId, createdAt])
  @@index([referenceType, referenceId])
}

/// Tenant-specific pricing configuration
model TenantPricing {
  id                     String          @id @default(cuid())
  tenantId               String
  service                TenantService
  currency               BillingCurrency @default(INR)
  // ePaper specific pricing
  minEpaperPages         Int?            @default(8)
  pricePerPageMinor      Int? // Price per ePaper page in paise
  // Fixed service pricing
  monthlyFeeMinor        Int? // For NEWS_WEBSITE, PRINT_SERVICE, etc.
  // Bulk payment discounts
  discount6MonthPercent  Decimal?        @default(5.0) @db.Decimal(5, 2)
  discount12MonthPercent Decimal?        @default(15.0) @db.Decimal(5, 2)
  isActive               Boolean         @default(true)
  effectiveFrom          DateTime        @default(now())
  effectiveUntil         DateTime?
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  tenant                 Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, service, effectiveFrom])
  @@index([tenantId, isActive])
}

/// Monthly usage tracking for billing
model TenantUsageMonthly {
  id                     String          @id @default(cuid())
  tenantId               String
  periodStart            DateTime // First day of billing month
  periodEnd              DateTime // Last day of billing month
  // ePaper usage
  epaperPageCount        Int             @default(0)
  epaperChargeMinor      Int             @default(0)
  // Other services
  newsWebsiteActive      Boolean         @default(false)
  newsWebsiteChargeMinor Int             @default(0)
  printChargeMinor       Int             @default(0)
  otherChargesMinor      Int             @default(0)
  totalChargeMinor       Int             @default(0)
  invoiceId              String?         @unique
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  tenant                 Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice                BillingInvoice? @relation(fields: [invoiceId], references: [id])

  @@unique([tenantId, periodStart])
  @@index([periodStart, periodEnd])
}

model DomainCategory {
  id         String   @id @default(cuid())
  domainId   String
  categoryId String
  createdAt  DateTime @default(now())
  category   Category @relation(fields: [categoryId], references: [id])
  domain     Domain   @relation(fields: [domainId], references: [id], onDelete: Cascade)

  @@unique([domainId, categoryId])
  @@index([categoryId])
}

model DomainLanguage {
  id         String   @id @default(cuid())
  domainId   String
  languageId String
  createdAt  DateTime @default(now())
  domain     Domain   @relation(fields: [domainId], references: [id], onDelete: Cascade)
  language   Language @relation(fields: [languageId], references: [id])

  @@unique([domainId, languageId])
  @@index([languageId])
}

model DomainCheckLog {
  id        String   @id @default(cuid())
  domainId  String
  checkedAt DateTime @default(now())
  result    String
  details   Json?
  domain    Domain   @relation(fields: [domainId], references: [id], onDelete: Cascade)

  @@index([domainId, checkedAt])
}

/// Global platform defaults; singleton row recommended.
model EntitySettings {
  id        String   @id @default(cuid())
  data      Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Per-tenant overrides for branding/theme/layout/etc.
model TenantSettings {
  id        String   @id @default(cuid())
  tenantId  String   @unique
  data      Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation("Tenant_TenantSettings", fields: [tenantId], references: [id], onDelete: Cascade)
}

/// Per-domain branding and settings.
model DomainSettings {
  id        String   @id @default(cuid())
  domainId  String   @unique
  tenantId  String
  data      Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  domain    Domain   @relation("Domain_DomainSettings", fields: [domainId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation("Tenant_DomainSettings", fields: [tenantId], references: [id], onDelete: Cascade)
}

model TenantTheme {
  id             String   @id @default(cuid())
  tenantId       String   @unique
  logoUrl        String?
  faviconUrl     String?
  primaryColor   String?
  headerHtml     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  /// Optional per-style homepage settings JSON.
  /// Recommended shape: { "style1": { ... }, "style2": { ... } }
  homepageConfig Json?
  fontFamily     String?
  footerBgColor  String?
  footerHtml     String?
  headerBgColor  String?
  secondaryColor String?
  /// SEO configuration JSON
  /// Shape: { metaTitle, metaDescription, metaKeywords, ogTitle, ogDescription, ogImage, twitterCard, twitterHandle, googleAnalyticsId, facebookPixelId, robotsTxt, sitemapEnabled }
  seoConfig      Json?
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

/// One-to-one PRGI registration and entity details for a Tenant
model TenantEntity {
  id                    String      @id @default(cuid())
  tenantId              String      @unique
  prgiNumber            String      @unique
  registrationTitle     String?
  periodicity           Periodicity @default(DAILY)
  registrationDate      DateTime?
  languageId            String?
  ownerName             String?
  publisherName         String?
  editorName            String?
  publicationCountryId  String?
  publicationStateId    String?
  publicationDistrictId String?
  publicationMandalId   String?
  printingPressName     String?
  printingDistrictId    String?
  printingMandalId      String?
  printingCityName      String?
  address               String?
  // Contact details
  contactMobile         String?
  contactEmail          String?
  contactPerson         String?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  nativeName            String?
  language              Language?   @relation("TenantEntity_language", fields: [languageId], references: [id])
  printingDistrict      District?   @relation("TenantEntity_printingDistrict", fields: [printingDistrictId], references: [id])
  printingMandal        Mandal?     @relation("TenantEntity_printingMandal", fields: [printingMandalId], references: [id])
  publicationCountry    Country?    @relation("TenantEntity_publicationCountry", fields: [publicationCountryId], references: [id])
  publicationDistrict   District?   @relation("TenantEntity_publicationDistrict", fields: [publicationDistrictId], references: [id])
  publicationMandal     Mandal?     @relation("TenantEntity_publicationMandal", fields: [publicationMandalId], references: [id])
  publicationState      State?      @relation("TenantEntity_publicationState", fields: [publicationStateId], references: [id])
  tenant                Tenant      @relation("Tenant_TenantEntity", fields: [tenantId], references: [id], onDelete: Cascade)
}

model TenantNavigation {
  id        String   @id @default(cuid())
  tenantId  String   @unique
  config    Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model TenantFeatureFlags {
  id                        String   @id @default(cuid())
  tenantId                  String   @unique
  enableMobileAppView       Boolean  @default(false)
  section2Rows              Int      @default(2)
  section2ListCount         Int      @default(4)
  section2ForceCategoryName String?
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  aiArticleRewriteEnabled   Boolean  @default(true)
  aiBillingEnabled          Boolean  @default(false)
  aiMonthlyTokenLimit       Int?
  enableAds                 Boolean  @default(true)
  enableBreakingNews        Boolean  @default(false)
  enableComments            Boolean  @default(false)
  enableDarkMode            Boolean  @default(true)
  enableEpaper              Boolean  @default(false)
  enableGallery             Boolean  @default(true)
  enableLiveTv              Boolean  @default(false)
  enableLocationFilter      Boolean  @default(false)
  enableMultiLang           Boolean  @default(false)
  enableNewsletter          Boolean  @default(true)
  enablePolls               Boolean  @default(false)
  enablePushNotifications   Boolean  @default(false)
  enableRelatedArticles     Boolean  @default(true)
  enableReporterBylines     Boolean  @default(true)
  enableSearch              Boolean  @default(true)
  enableSocialShare         Boolean  @default(true)
  enableTrending            Boolean  @default(true)
  enableVideo               Boolean  @default(true)
  tenant                    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

/// Token-based AI usage metering per tenant (for billing/auditing).
/// Written by workers/controllers where tenantId is known.
model AiUsageEvent {
  id               String   @id @default(cuid())
  tenantId         String
  articleId        String?
  provider         String
  model            String?
  purpose          String
  promptTokens     Int?
  completionTokens Int?
  totalTokens      Int?
  promptChars      Int?
  responseChars    Int?
  rawUsage         Json?
  createdAt        DateTime @default(now())
  article          Article? @relation(fields: [articleId], references: [id])
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@index([articleId])
}

model TenantHomepageSection {
  id          String   @id @default(cuid())
  tenantId    String
  sectionName String
  items       Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, sectionName])
  @@index([tenantId, sectionName])
}

/// Style2 homepage section configuration - links sections to categories with customizable labels
/// Section Types for Style2 Layout:
/// - hero_sidebar: Main hero with sidebar (uses category + secondaryCategory + tertiaryCategory)
/// - category_boxes_3col: 3-column category boxes (uses categorySlugs[])
/// - small_cards_3col: 3-column small cards (uses categorySlugs[])
/// - magazine_grid: Magazine-style grid layout (uses category)
/// - horizontal_scroll: Horizontal scrolling cards (uses category)
/// - spotlight: Featured spotlight section (uses category)
/// - newspaper_columns: Traditional newspaper columns (uses categorySlugs[])
/// - horizontal_cards: Horizontal card layout (uses category)
/// - photo_gallery: Photo gallery section (uses category)
/// - timeline: Timeline-style news feed (uses category)
/// - featured_banner: Featured banner section (uses category)
/// - compact_lists_2col: 2-column compact lists (uses categorySlugs[])
/// Query Kinds:
/// - category: Fetch articles from linked category
/// - latest: Fetch latest articles across all categories
/// - trending: Fetch trending/popular articles
/// - most_viewed: Fetch most viewed articles
model HomepageSectionConfig {
  id                    String    @id @default(cuid())
  tenantId              String
  domainId              String?
  /// Unique section key (e.g., "hero", "politics", "sports", "section1", etc.)
  key                   String
  /// Display label in tenant's language (e.g., "" for Telugu Politics)
  label                 String
  /// English fallback label
  labelEn               String?
  /// Position/order on homepage (lower = higher on page)
  position              Int       @default(0)
  /// Section display style: "hero", "grid", "list", "cards", "ticker" (legacy)
  style                 String    @default("cards")
  categoryId            String?
  /// Cached category slug for fast lookup
  categorySlug          String?
  /// Number of articles to show in this section
  articleLimit          Int       @default(6)
  /// Whether this section is visible on homepage
  isActive              Boolean   @default(true)
  /// Extra config JSON (for future extensions like colors, icons, etc.)
  config                Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  /// Section type for Style2 layout (hero_sidebar, category_boxes_3col, magazine_grid, etc.)
  sectionType           String    @default("category_cards")
  /// Query kind: "category", "latest", "trending", "most_viewed"
  queryKind             String    @default("category")
  secondaryCategoryId   String?
  secondaryCategorySlug String?
  tertiaryCategoryId    String?
  tertiaryCategorySlug  String?
  /// Array of category slugs for multi-category sections (category_boxes_3col, small_cards_3col, etc.)
  categorySlugs         Json?
  category              Category? @relation("HomepageSectionConfig_category", fields: [categoryId], references: [id])
  domain                Domain?   @relation(fields: [domainId], references: [id], onDelete: Cascade)
  secondaryCategory     Category? @relation("HomepageSectionConfig_secondaryCategory", fields: [secondaryCategoryId], references: [id])
  tenant                Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tertiaryCategory      Category? @relation("HomepageSectionConfig_tertiaryCategory", fields: [tertiaryCategoryId], references: [id])

  @@unique([tenantId, domainId, key])
  @@index([tenantId, domainId, position])
  @@index([categoryId])
  @@index([sectionType])
  @@index([queryKind])
}

model NewsletterSubscription {
  id        String   @id @default(cuid())
  tenantId  String
  email     String
  source    String?
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, email])
  @@index([tenantId])
}

model Reporter {
  id                         String                  @id @default(cuid())
  tenantId                   String
  level                      ReporterLevel?
  stateId                    String?
  districtId                 String?
  divisionId                 String?                 // New: For DIVISION level (can be districtId or mandalId)
  constituencyId             String?                 // New: For CONSTITUENCY level (can be districtId, mandalId, or assemblyConstituencyId)
  mandalId                   String?
  active                     Boolean                 @default(true)
  createdAt                  DateTime                @default(now())
  updatedAt                  DateTime                @updatedAt
  userId                     String?                 @unique
  designationId              String?
  kycData                    Json?
  kycStatus                  KycStatus               @default(PENDING)
  monthlySubscriptionAmount  Int?
  subscriptionActive         Boolean                 @default(false)
  subscriptionActivationDate DateTime?               // Scheduled activation date
  assemblyConstituencyId     String?
  idCardCharge               Int?
  profilePhotoUrl            String?
  manualLoginActivatedAt     DateTime?
  manualLoginDays            Int?
  manualLoginEnabled         Boolean                 @default(false)
  manualLoginExpiresAt       DateTime?
  assemblyConstituency       AssemblyConstituency?   @relation(fields: [assemblyConstituencyId], references: [id])
  designation                ReporterDesignation?    @relation(fields: [designationId], references: [id])
  district                   District?               @relation(fields: [districtId], references: [id])
  mandal                     Mandal?                 @relation(fields: [mandalId], references: [id])
  state                      State?                  @relation(fields: [stateId], references: [id])
  tenant                     Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user                       User?                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  idCard                     ReporterIDCard?
  payments                   ReporterPayment[]
  articleQuota               ReporterArticleQuota?

  @@index([tenantId, level])
  @@index([designationId])
  @@index([kycStatus])
  @@index([manualLoginEnabled, manualLoginExpiresAt])
}

model AssemblyConstituency {
  id         String     @id @default(cuid())
  name       String
  districtId String
  isDeleted  Boolean    @default(false)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  district   District   @relation("DistrictAssemblyConstituencies", fields: [districtId], references: [id])
  reporters  Reporter[]

  @@unique([districtId, name])
  @@index([districtId])
}

model ReporterDesignation {
  id               String                    @id @default(cuid())
  tenantId         String?
  level            ReporterLevel
  levelOrder       Int                       // Hierarchy: 1=highest (State Bureau Chief), 2=Staff Reporter, 3=RC In-charge, 4=Mandal Reporter
  code             String
  name             String
  nativeName       String?                   // Telugu/Hindi/Regional language name
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt
  reporters        Reporter[]
  tenant           Tenant?                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  onboardingOrders ReporterOnboardingOrder[]

  @@unique([tenantId, code])
  @@index([tenantId, level])
  @@index([tenantId, levelOrder])
}

model ReporterIDCard {
  id         String   @id @default(cuid())
  reporterId String   @unique
  cardNumber String   @unique
  issuedAt   DateTime
  expiresAt  DateTime
  pdfUrl     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  reporter   Reporter @relation(fields: [reporterId], references: [id], onDelete: Cascade)
}

/// Per-tenant ID card layout & numbering settings
model TenantIdCardSettings {
  id              String    @id @default(cuid())
  tenantId        String    @unique
  templateId      String    @default("STYLE_1")
  frontLogoUrl    String?
  roundStampUrl   String?
  signUrl         String?
  primaryColor    String?
  secondaryColor  String?
  termsJson       Json?
  officeAddress   String?
  helpLine1       String?
  helpLine2       String?
  validityType    String    @default("PER_USER_DAYS")
  validityDays    Int?
  fixedValidUntil DateTime?
  idPrefix        String?
  idDigits        Int?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

/// Tenant-wide daily article quota defaults for all reporters
model TenantArticleQuota {
  id                String   @id @default(cuid())
  tenantId          String   @unique
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  maxPriority1Daily Int      @default(5) // High priority
  maxPriority2Daily Int      @default(10) // Medium priority
  maxPriority3Daily Int      @default(20) // Low priority
  maxTotalDaily     Int      @default(30) // Total articles per day
  enforceQuota      Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([tenantId])
}

/// Per-reporter daily article quota overrides
model ReporterArticleQuota {
  id                String   @id @default(cuid())
  reporterId        String   @unique
  reporter          Reporter @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  maxPriority1Daily Int? // null = use tenant default
  maxPriority2Daily Int?
  maxPriority3Daily Int?
  maxTotalDaily     Int?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([reporterId])
  @@index([isActive])
}

model Village {
  id           String               @id @default(cuid())
  tenantId     String
  mandalId     String
  name         String
  isDeleted    Boolean              @default(false)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  mandal       Mandal               @relation(fields: [mandalId], references: [id])
  tenant       Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  translations VillageTranslation[]

  @@unique([tenantId, mandalId, name])
  @@index([tenantId])
  @@index([mandalId])
  @@index([name])
}

model VillageTranslation {
  id        String   @id @default(cuid())
  villageId String
  language  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  village   Village  @relation(fields: [villageId], references: [id], onDelete: Cascade)

  @@unique([villageId, language])
}

model ReporterPayment {
  id                String                @id @default(cuid())
  reporterId        String
  year              Int
  amount            Int
  status            ReporterPaymentStatus @default(PENDING)
  expiresAt         DateTime
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  currency          String                @default("INR")
  meta              Json?
  month             Int
  razorpayOrderId   String?
  razorpayPaymentId String?
  tenantId          String
  type              String
  reporter          Reporter              @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  tenant            Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([reporterId, type, year, month])
  @@index([status])
}

/// Payment-first public onboarding order.
/// Stores pre-registration details keyed by `razorpayOrderId` so a reporter slot
/// isn't consumed until payment is captured.
model ReporterOnboardingOrder {
  id                        String              @id @default(cuid())
  tenantId                  String
  mobileNumber              String
  fullName                  String
  languageId                String?
  designationId             String
  level                     ReporterLevel
  stateId                   String?
  districtId                String?
  mandalId                  String?
  assemblyConstituencyId    String?
  subscriptionEnabled       Boolean             @default(true)
  monthlySubscriptionAmount Int?
  subscriptionActivationDate DateTime?           // When subscription should activate
  idCardCharge              Int?
  amount                    Int
  currency                  String              @default("INR")
  status                    String              @default("PENDING")
  razorpayOrderId           String              @unique
  razorpayPaymentId         String?
  meta                      Json?
  expiresAt                 DateTime
  createdAt                 DateTime            @default(now())
  updatedAt                 DateTime            @updatedAt
  designation               ReporterDesignation @relation(fields: [designationId], references: [id])
  tenant                    Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, mobileNumber])
  @@index([status])
}

/// Razorpay configuration per tenant (or global when tenantId is null)
model RazorpayConfig {
  id        String   @id @default(cuid())
  tenantId  String?  @unique
  keyId     String
  keySecret String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model ArticleView {
  id        String   @id @default(cuid())
  articleId String
  userId    String?
  deviceId  String?
  viewedAt  DateTime @default(now())
  article   Article  @relation(fields: [articleId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])
}

model ArticleRead {
  id               String    @id @default(cuid())
  userId           String
  articleId        String
  readAt           DateTime  @default(now())
  totalTimeMs      Int       @default(0)
  maxScrollPercent Float     @default(0)
  completed        Boolean   @default(false)
  lastEventAt      DateTime?
  completedAt      DateTime?
  sessionsCount    Int       @default(0)
  article          Article   @relation(fields: [articleId], references: [id])
  user             User      @relation(fields: [userId], references: [id])

  @@unique([userId, articleId])
}

model Like {
  id        String   @id @default(cuid())
  userId    String
  articleId String
  createdAt DateTime @default(now())
  article   Article  @relation(fields: [articleId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, articleId])
}

model Dislike {
  id        String   @id @default(cuid())
  userId    String
  articleId String
  createdAt DateTime @default(now())
  article   Article  @relation(fields: [articleId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, articleId])
}

model ShortNewsRead {
  id               String    @id @default(cuid())
  userId           String
  shortNewsId      String
  readAt           DateTime  @default(now())
  completed        Boolean   @default(false)
  completedAt      DateTime?
  lastEventAt      DateTime?
  maxScrollPercent Float     @default(0)
  sessionsCount    Int       @default(0)
  totalTimeMs      Int       @default(0)
  deviceId         String?
  shortNews        ShortNews @relation(fields: [shortNewsId], references: [id])
  user             User      @relation(fields: [userId], references: [id])

  @@unique([userId, shortNewsId])
}

model NewspaperArticle {
  id                       String               @id @default(cuid())
  tenantId                 String
  authorId                 String
  languageId               String?
  baseArticleId            String?
  title                    String
  subTitle                 String?
  heading                  String
  points                   String[]
  dateline                 String
  content                  String
  placeName                String?
  status                   String               @default("DRAFT")
  createdAt                DateTime             @default(now())
  updatedAt                DateTime             @updatedAt
  districtId               String?
  mandalId                 String?
  stateId                  String?
  villageId                String?
  categoryId               String?
  lead                     String?
  assignedBlockTemplateId  String?
  charCount                Int?
  featuredImageUrl         String?
  isBreaking               Boolean              @default(false)
  mediaUrls                String[]
  priority                 Int                  @default(0)
  suggestedBlockTemplateId String?
  wordCount                Int?
  pageLayouts              EpaperPageLayout[]
  assignedBlockTemplate    EpaperBlockTemplate? @relation("Article_AssignedBlock", fields: [assignedBlockTemplateId], references: [id])
  author                   User                 @relation(fields: [authorId], references: [id])
  baseArticle              Article?             @relation("ArticleToNewspaper", fields: [baseArticleId], references: [id])
  category                 Category?            @relation(fields: [categoryId], references: [id])
  language                 Language?            @relation(fields: [languageId], references: [id])
  suggestedBlockTemplate   EpaperBlockTemplate? @relation("Article_SuggestedBlock", fields: [suggestedBlockTemplateId], references: [id])
  tenant                   Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([categoryId])
  @@index([stateId])
  @@index([districtId])
  @@index([mandalId])
  @@index([villageId])
  @@index([suggestedBlockTemplateId])
  @@index([assignedBlockTemplateId])
  @@index([priority])
  @@index([status])
}

model ContentRead {
  id               String      @id @default(cuid())
  userId           String
  contentId        String
  contentType      ContentType
  readAt           DateTime    @default(now())
  totalTimeMs      Int         @default(0)
  maxScrollPercent Float       @default(0)
  completed        Boolean     @default(false)
  lastEventAt      DateTime?
  completedAt      DateTime?
  sessionsCount    Int         @default(0)
  latitude         Float?
  longitude        Float?
  accuracyMeters   Float?
  placeId          String?
  placeName        String?
  address          String?
  stateId          String?
  districtId       String?
  mandalId         String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  district         District?   @relation("ContentRead_district", fields: [districtId], references: [id])
  mandal           Mandal?     @relation("ContentRead_mandal", fields: [mandalId], references: [id])
  state            State?      @relation("ContentRead_state", fields: [stateId], references: [id])
  user             User        @relation(fields: [userId], references: [id])

  @@unique([userId, contentType, contentId])
  @@index([contentType, contentId])
  @@index([stateId])
  @@index([districtId])
  @@index([mandalId])
}

/// Unified reactions across Article & ShortNews. Replaces legacy Like/Dislike tables going forward.
model ContentReaction {
  id          String        @id @default(cuid())
  userId      String
  contentId   String
  contentType ContentType
  reaction    ReactionValue
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  user        User          @relation(fields: [userId], references: [id])

  @@unique([userId, contentType, contentId])
  @@index([contentType, contentId])
  @@index([userId])
}

model FamilyRelation {
  id            String             @id @default(cuid())
  userId        String
  relatedUserId String
  relationType  FamilyRelationType
  meta          Json?
  createdAt     DateTime           @default(now())
  relatedUser   User               @relation("FamilyRelation_relatedUser", fields: [relatedUserId], references: [id], onDelete: Cascade)
  user          User               @relation("FamilyRelation_user", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, relatedUserId, relationType])
  @@index([userId])
  @@index([relatedUserId])
}

/// Optional grouping of users into named families (e.g., by surname or explicit unit)
model Family {
  id         String         @id @default(cuid())
  familyName String?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  members    FamilyMember[]
}

model FamilyMember {
  id       String   @id @default(cuid())
  familyId String
  userId   String
  role     String?
  addedAt  DateTime @default(now())
  family   Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([familyId, userId])
  @@index([userId])
}

/// Auto-suggestable surname dictionary.
/// - Never delete.
/// - Create if missing.
model Surname {
  id              String       @id @default(cuid())
  surnameEn       String
  surnameNative   String?
  stateId         String?
  createdByUserId String?
  isVerified      Boolean      @default(false)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  familyTrees     FamilyTree[]
  createdByUser   User?        @relation(fields: [createdByUserId], references: [id])
  state           State?       @relation(fields: [stateId], references: [id])

  @@unique([stateId, surnameEn])
  @@index([surnameEn])
  @@index([stateId])
}

/// New simplified Family Tree (placeholder-friendly) to avoid disturbing legacy Family/FamilyMember.
model FamilyTree {
  id              String             @id @default(cuid())
  side            FamilyTreeSide
  groupName       String?
  rootMemberId    String?
  createdByUserId String
  surnameId       String?
  villageId       String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  createdByUser   User               @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)
  surname         Surname?           @relation(fields: [surnameId], references: [id])
  members         FamilyTreeMember[]

  @@unique([createdByUserId, side])
  @@index([createdByUserId])
  @@index([side])
  @@index([surnameId])
  @@index([villageId])
}

model FamilyTreeMember {
  id             String             @id @default(cuid())
  familyTreeId   String
  userId         String?
  fullName       String
  kinRelationId  String?
  parentMemberId String?
  isPlaceholder  Boolean            @default(false)
  isVerified     Boolean            @default(false)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  familyTree     FamilyTree         @relation(fields: [familyTreeId], references: [id], onDelete: Cascade)
  kinRelation    KinRelation?       @relation(fields: [kinRelationId], references: [id])
  parentMember   FamilyTreeMember?  @relation("FamilyTreeMember_Parent", fields: [parentMemberId], references: [id])
  children       FamilyTreeMember[] @relation("FamilyTreeMember_Parent")
  user           User?              @relation(fields: [userId], references: [id])

  @@unique([familyTreeId, userId])
  @@index([familyTreeId])
  @@index([userId])
  @@index([parentMemberId])
  @@index([kinRelationId])
}

/// Dictionary of kinship relation labels in multiple languages
model KinRelation {
  id                String             @id @default(cuid())
  code              String             @unique
  category          String
  gender            String?
  side              String?
  generationUp      Int                @default(0)
  generationDown    Int                @default(0)
  en                String
  te                String
  isCommon          Boolean            @default(true)
  notes             Json?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  familyTreeMembers FamilyTreeMember[]
  names             KinRelationName[]
}

/// Language-specific display names for KinRelation codes.
/// Keeps language strings separate from the logical KinRelation row.
model KinRelationName {
  id            String      @id @default(cuid())
  kinRelationId String
  languageCode  String
  displayName   String
  altNames      String[]
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  kinRelation   KinRelation @relation(fields: [kinRelationId], references: [id], onDelete: Cascade)

  @@unique([kinRelationId, languageCode])
  @@index([languageCode])
}

model Comment {
  id          String     @id @default(cuid())
  content     String
  userId      String
  articleId   String?
  parentId    String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  shortNewsId String?
  article     Article?   @relation(fields: [articleId], references: [id])
  parent      Comment?   @relation("Replies", fields: [parentId], references: [id])
  replies     Comment[]  @relation("Replies")
  shortNews   ShortNews? @relation(fields: [shortNewsId], references: [id])
  user        User       @relation(fields: [userId], references: [id])

  @@index([articleId])
  @@index([shortNewsId])
  @@index([parentId])
}

model Media {
  id            String        @id @default(cuid())
  key           String        @unique
  url           String
  name          String
  contentType   String
  size          Int
  kind          String
  folder        String?
  ownerId       String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  owner         User?         @relation(fields: [ownerId], references: [id])
  profilePhotos UserProfile[] @relation("UserProfile_profilePhotoMedia")
}

/// User profile details separated from the core User
model UserProfile {
  id                     String    @id @default(cuid())
  userId                 String    @unique
  fullName               String?
  gender                 String?
  dob                    DateTime?
  maritalStatus          String?
  bio                    String?
  profilePhotoUrl        String?
  profilePhotoMediaId    String?
  emergencyContactNumber String?
  address                Json?
  stateId                String?
  districtId             String?
  mandalId               String?
  assemblyId             String?
  villageId              String?
  occupation             String?
  education              String?
  socialLinks            Json?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  caste                  String?
  casteId                String?
  lastName               String?
  subCaste               String?
  subCasteId             String?
  surname                String?
  casteRef               Caste?    @relation("UserProfile_casteRef", fields: [casteId], references: [id])
  district               District? @relation("UserProfile_district", fields: [districtId], references: [id])
  mandal                 Mandal?   @relation("UserProfile_mandal", fields: [mandalId], references: [id])
  profilePhotoMedia      Media?    @relation("UserProfile_profilePhotoMedia", fields: [profilePhotoMediaId], references: [id])
  state                  State?    @relation("UserProfile_state", fields: [stateId], references: [id])
  subCasteRef            SubCaste? @relation("UserProfile_subCasteRef", fields: [subCasteId], references: [id])
  user                   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// Caste and SubCaste lookups (optional references from UserProfile)
model Caste {
  id        String        @id @default(cuid())
  name      String        @unique
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  subCastes SubCaste[]
  profiles  UserProfile[] @relation("UserProfile_casteRef")
}

model SubCaste {
  id        String        @id @default(cuid())
  name      String
  casteId   String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  caste     Caste         @relation(fields: [casteId], references: [id], onDelete: Cascade)
  profiles  UserProfile[] @relation("UserProfile_subCasteRef")

  @@unique([casteId, name])
}

/// Public encryption key material per user (E2EE bootstrap). No private keys stored.
model UserEncryptionKey {
  userId          String   @id
  identityKey     String
  signedPreKey    String?
  signedPreKeySig String?
  oneTimePreKeys  Json     @default("[]")
  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// One-line options/opinions posted by a user for a ShortNews.
/// - At most one option per (user, shortNews)
/// - content is limited to 50 characters
model ShortNewsOption {
  id          String    @id @default(cuid())
  shortNewsId String
  userId      String
  type        ShortNewsOptionType @default(POSITIVE)
  content     String    @db.VarChar(50)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  shortNews   ShortNews @relation(fields: [shortNewsId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@unique([userId, shortNewsId])
  @@index([shortNewsId])
  @@index([userId])
}

/// Device registration and last-known location per device
model Device {
  id             String   @id @default(cuid())
  userId         String?
  deviceId       String   @unique
  deviceModel    String?
  pushToken      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  latitude       Float?
  longitude      Float?
  accuracyMeters Float?
  placeId        String?
  placeName      String?
  address        String?
  source         String?
  user           User?    @relation(fields: [userId], references: [id])
}

/// Canonical location for a registered user (separate from device)
model UserLocation {
  userId         String    @id
  latitude       Float
  longitude      Float
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  accuracyMeters Float?
  provider       String?
  timestampUtc   DateTime?
  placeId        String?
  placeName      String?
  address        String?
  source         String?
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// GDPR Account Deletion Request (Article 17 - Right to Erasure)
model DeletionRequest {
  id          String                  @id @default(cuid())
  userId      String
  reason      String                  @default("user_requested")
  status      DeletionRequestStatus   @default(PENDING)
  requestedAt DateTime                @default(now())
  dueDate     DateTime                /// GDPR requires processing within 30 days
  completedAt DateTime?
  adminNotes  String?
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  @@index([userId])
  @@index([status])
}

/// Reusable block templates for ePaper newspaper design.
/// Templates define layout rules (columns, height) and component styles (title, image, body).
/// Can be global (platform-wide) or tenant-specific.
model EpaperBlockTemplate {
  id                    String                 @id @default(cuid())
  code                  String                 @unique
  name                  String
  description           String?
  category              EpaperBlockCategory
  subCategory           EpaperBlockSubCategory
  columns               Int
  widthInches           Float
  minHeightInches       Float?
  maxHeightInches       Float
  components            Json
  previewImageUrl       String?
  isLocked              Boolean                @default(false)
  status                EpaperBlockStatus      @default(DRAFT)
  isGlobal              Boolean                @default(true)
  tenantId              String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  tenant                Tenant?                @relation("Tenant_EpaperBlockTemplates", fields: [tenantId], references: [id], onDelete: Cascade)
  pageLayouts           EpaperPageLayout[]
  settingsAsFooter      EpaperSettings[]       @relation("EpaperSettings_Footer")
  settingsAsInnerHeader EpaperSettings[]       @relation("EpaperSettings_InnerHeader")
  settingsAsMainHeader  EpaperSettings[]       @relation("EpaperSettings_MainHeader")
  assignedToArticles    NewspaperArticle[]     @relation("Article_AssignedBlock")
  suggestedForArticles  NewspaperArticle[]     @relation("Article_SuggestedBlock")

  @@index([category])
  @@index([subCategory])
  @@index([tenantId])
  @@index([status])
}

/// Per-tenant ePaper configuration: page size, padding, headers, footers, generation settings.
model EpaperSettings {
  id                        String               @id @default(cuid())
  tenantId                  String               @unique
  pageWidthInches           Float                @default(13)
  pageHeightInches          Float                @default(22)
  gridColumns               Int                  @default(12)
  paddingTop                Float                @default(0.5)
  paddingRight              Float                @default(0.5)
  paddingBottom             Float                @default(0.5)
  paddingLeft               Float                @default(0.5)
  defaultPageCount          Int                  @default(8)
  mainHeaderTemplateId      String?
  mainHeaderHeightInches    Float                @default(3)
  innerHeaderTemplateId     String?
  innerHeaderHeightInches   Float                @default(1)
  footerTemplateId          String?
  footerHeightInches        Float                @default(0.5)
  footerStyle               String               @default("dots")
  showPrinterInfoOnLastPage Boolean              @default(true)
  printerName               String?
  printerAddress            String?
  printerCity               String?
  publisherName             String?
  editorName                String?
  ownerName                 String?
  rniNumber                 String?
  lastPageFooterTemplate    String?
  generationConfig          Json?
  createdAt                 DateTime             @default(now())
  updatedAt                 DateTime             @updatedAt
  footerTemplate            EpaperBlockTemplate? @relation("EpaperSettings_Footer", fields: [footerTemplateId], references: [id])
  innerHeaderTemplate       EpaperBlockTemplate? @relation("EpaperSettings_InnerHeader", fields: [innerHeaderTemplateId], references: [id])
  mainHeaderTemplate        EpaperBlockTemplate? @relation("EpaperSettings_MainHeader", fields: [mainHeaderTemplateId], references: [id])
  tenant                    Tenant               @relation("Tenant_EpaperSettings", fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

/// Daily ePaper edition for a tenant.
model EpaperEdition {
  id             String              @id @default(cuid())
  tenantId       String
  editionDate    DateTime            @db.Date
  editionNumber  Int?
  totalPages     Int                 @default(8)
  status         EpaperEditionStatus @default(DRAFT)
  pdfUrl         String?
  pdfGeneratedAt DateTime?
  thumbnailUrl   String?
  generatedAt    DateTime?
  generatedBy    String?
  generationLog  Json?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  tenant         Tenant              @relation("Tenant_EpaperEditions", fields: [tenantId], references: [id], onDelete: Cascade)
  pageLayouts    EpaperPageLayout[]

  @@unique([tenantId, editionDate])
  @@index([tenantId])
  @@index([editionDate])
  @@index([status])
}

/// Computed layout positions for each block in an edition page.
/// Stores x,y coordinates, dimensions, and rendered content after layout algorithm runs.
model EpaperPageLayout {
  id              String              @id @default(cuid())
  editionId       String
  pageNumber      Int
  articleId       String?
  blockTemplateId String
  x               Float
  y               Float
  width           Float
  height          Float
  renderedContent Json?
  sortOrder       Int                 @default(0)
  isHeader        Boolean             @default(false)
  isFooter        Boolean             @default(false)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  article         NewspaperArticle?   @relation(fields: [articleId], references: [id])
  blockTemplate   EpaperBlockTemplate @relation(fields: [blockTemplateId], references: [id])
  edition         EpaperEdition       @relation(fields: [editionId], references: [id], onDelete: Cascade)

  @@index([editionId])
  @@index([pageNumber])
  @@index([articleId])
  @@index([blockTemplateId])
}

/// Proof request created by admin/editor for an article
model ArticleProofRequest {
  id             String                 @id @default(cuid())
  articleType    String
  webArticleId   String?
  shortNewsId    String?
  articleId      String?
  tenantId       String
  requestedById  String
  assignedToId   String
  reason         String
  priority       String                 @default("NORMAL")
  status         ProofRequestStatus     @default(PENDING)
  previousStatus String?
  reviewedById   String?
  reviewNote     String?
  dueDate        DateTime?
  submittedAt    DateTime?
  resolvedAt     DateTime?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  evidence       ArticleProofEvidence[]
  assignedTo     User                   @relation("ProofRequest_AssignedTo", fields: [assignedToId], references: [id])
  requestedBy    User                   @relation("ProofRequest_RequestedBy", fields: [requestedById], references: [id])
  reviewedBy     User?                  @relation("ProofRequest_ReviewedBy", fields: [reviewedById], references: [id])
  tenant         Tenant                 @relation("Tenant_ProofRequests", fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([assignedToId, status])
  @@index([webArticleId])
  @@index([shortNewsId])
  @@index([articleId])
}

/// Evidence uploaded by reporter for a proof request
model ArticleProofEvidence {
  id             String              @id @default(cuid())
  proofRequestId String
  mediaType      ProofMediaType
  mediaUrl       String
  thumbnailUrl   String?
  fileName       String?
  fileSize       Int?
  mimeType       String?
  description    String?
  uploadedById   String
  createdAt      DateTime            @default(now())
  proofRequest   ArticleProofRequest @relation(fields: [proofRequestId], references: [id], onDelete: Cascade)
  uploadedBy     User                @relation("ProofEvidence_UploadedBy", fields: [uploadedById], references: [id])

  @@index([proofRequestId])
}

enum PrgiStatus {
  PENDING
  SUBMITTED
  VERIFIED
  REJECTED
}

enum DomainStatus {
  PENDING
  VERIFYING
  ACTIVE
  SUSPENDED
  DECOMMISSIONED
}

/// Distinguish between a news website domain and an ePaper subdomain/domain for billing & feature gating.
enum DomainKind {
  NEWS
  EPAPER
}

enum ReporterRole {
  SUPER_ADMIN
  TENANT_ADMIN
  ADMIN_EDITOR
  NEWS_MODERATOR
  PARENT_REPORTER
  REPORTER
  GUEST_REPORTER
}

enum ReporterLevel {
  STATE
  DISTRICT
  DIVISION
  CONSTITUENCY
  ASSEMBLY
  MANDAL
}

enum ReporterPaymentStatus {
  PENDING
  PAID
  EXPIRED
  REFUNDED
}

enum KycStatus {
  PENDING
  SUBMITTED
  APPROVED
  REJECTED
}

/// PRGI periodicity for newspaper registration
enum Periodicity {
  DAILY
  WEEKLY
  FORTNIGHTLY
  MONTHLY
}

/// Category of ePaper block template
enum EpaperBlockCategory {
  HEADER
  CONTENT
  FOOTER
}

/// Sub-category for more specific block types
enum EpaperBlockSubCategory {
  MAIN_HEADER
  INNER_HEADER
  COL_2
  COL_4
  COL_6
  COL_10
  COL_12
  STANDARD_FOOTER
  LAST_PAGE_FOOTER
}

/// Status of ePaper block template
enum EpaperBlockStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

/// Status of ePaper edition generation
enum EpaperEditionStatus {
  DRAFT
  GENERATING
  GENERATED
  PUBLISHED
  FAILED
}

enum BillingCycle {
  MONTHLY
  QUARTERLY
  HALF_YEARLY
  YEARLY
}

/// Amounts are stored in minor currency units (e.g., paise for INR).
enum BillingCurrency {
  INR
  USD
}

enum BillingComponent {
  NEWS_DOMAIN
  EPAPER_SUBDOMAIN
  NEWSPAPER_DESIGN_PAGE
  EPAPER_PAGE            // Per-page billing for ePaper
  NEWS_WEBSITE_MONTHLY   // Monthly news website fee
  PRINT_MONTHLY          // Monthly print service
  CUSTOM_SERVICE         // Other custom services
}

enum WalletTransactionType {
  CREDIT        // Money added to wallet
  DEBIT         // Money deducted from wallet
  LOCK          // Balance reserved for pending invoice
  UNLOCK        // Released locked balance
  REFUND        // Money returned to wallet
  ADJUSTMENT    // Manual balance correction
}

enum TenantService {
  EPAPER              // ePaper service (page-based)
  NEWS_WEBSITE        // News website service (fixed monthly)
  PRINT_SERVICE       // Print service (fixed monthly)
  CUSTOM_SERVICE      // Other custom services
}

enum SubscriptionStatus {
  SCHEDULED   // Subscription scheduled for future activation
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  PAST_DUE  // Invoice not paid and overdue
}

/// Invoice purpose. SUBSCRIPTION is the regular period invoice; TOPUP is prepaid credit purchase.
enum BillingInvoiceKind {
  SUBSCRIPTION
  TOPUP
}

/// Unified content read tracking (dual-write while ArticleRead / ShortNewsRead still exist).
enum ContentType {
  ARTICLE
  SHORTNEWS
}

/// Reaction value for unified content reactions
enum ReactionValue {
  LIKE
  DISLIKE
}

/// Family relationship graph (directed edges). Store both directions for convenience.
enum FamilyRelationType {
  PARENT
  CHILD
  SPOUSE
  SIBLING
}

/// Family Tree side (one tree per side).
enum FamilyTreeSide {
  FATHER
  MOTHER
  SPOUSE
}

enum ProofRequestStatus {
  PENDING
  SUBMITTED
  APPROVED
  REJECTED
}

enum ProofMediaType {
  IMAGE
  VIDEO
  DOCUMENT
}

/// Status for GDPR deletion requests
enum DeletionRequestStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
}
